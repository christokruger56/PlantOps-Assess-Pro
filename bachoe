<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backhoe/Loader Observation Checklist - Assessment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #f5f5f5;
            line-height: 1.4;
        }
        .section {
            background-color: #fafafa;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }
        h1, h2, h3, h4, h5 {
            border-bottom: 2px solid #3498db;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        h1 { text-align: center; }
        .personal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="number"] {
            width: 80px;
        }
        textarea {
            height: 60px;
            resize: vertical;
        }
        .sop {
            background-color: #e3f2fd;
            padding: 10px;
            border-left: 4px solid #3498db;
            margin: 10px 0;
        }
        .sop ol {
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sop li {
            word-wrap: break-word;
            margin-bottom: 5px;
        }
        .assessment {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .assessment label {
            display: flex;
            align-items: center;
        }
        input[type="checkbox"], input[type="radio"] {
            margin-right: 10px;
        }
        .signature {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        .assessment-summary {
            display: block;
        }
        .competence-score {
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }
        .competence-score h4 {
            margin: 0 0 5px 0;
            color: #155724;
        }
        .thresholds {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            height: 100px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .so, .criteria, .question {
            margin-bottom: 15px;
        }
        .moderator-comments {
            margin-top: 10px;
        }
        .save-status {
            margin: 10px 0;
            padding: 10px;
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            border-radius: 4px;
            display: none;
        }
        .load-btn, .clear-btn {
            background-color: #17a2b8;
            margin-right: 10px;
        }
        .clear-btn {
            background-color: #dc3545;
        }
        .clear-btn:hover {
            background-color: #c82333;
        }
        .auto-filled {
            background-color: #e8f5e8;
            font-style: italic;
        }
        @media (max-width: 768px) {
            body {
                font-size: 14px;
                padding: 10px;
            }
            .personal-details, .signature, .thresholds {
                grid-template-columns: 1fr;
            }
            input, button, textarea {
                min-height: 44px;
                font-size: 13px;
            }
            input[type="checkbox"], input[type="radio"] {
                width: 18px;
                height: 18px;
            }
            .assessment {
                flex-direction: column;
                gap: 10px;
            }
            .assessment label {
                display: block;
            }
            canvas {
                height: 80px;
            }
        }
        @media print {
            body {
                margin: 0;
                background: white;
                font-size: 12px;
            }
            .section {
                box-shadow: none;
                background: white;
                margin: 5px 0;
                padding: 8px;
            }
            button, .save-status {
                display: none;
            }
            canvas {
                height: 60px !important;
            }
            h1, h2, h3, h4, h5 {
                border-bottom: 1px solid #3498db;
            }
        }
    </style>
</head>
<body>
    <form id="checklistForm">
        <div class="section">
            <h1>Observation Checklist for Backhoe/Loader Operation</h1>
    <!-- New Back Button -->
            <button onclick="goBackToDashboard()" style="background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">
                <i class="fas fa-arrow-left" style="margin-right: 5px;"></i>Back to Dashboard
            </button>
            <p>Unit Standard: Operate a Backhoe/Loader 262727 | NQF Level: 2 | Credits: 15</p>
        </div>

        <div id="save-status" class="save-status">
            <p><strong>Saved!</strong> Your progress is automatically saved to local storage.</p>
        </div>

        <div class="section">
            <h2>Personal Details</h2>
            <div class="personal-details">
                <div>
                    <label for="learnerName">Learner Name:</label>
                    <input type="text" id="learnerName" required>
                </div>
                <div>
                    <label for="learnerId">Learner ID:</label>
                    <input type="text" id="learnerId" required>
                </div>
                <div>
                    <label for="assessorName">Assessor Name:</label>
                    <input type="text" id="assessorName" required class="auto-filled">
                </div>
                <div>
                    <label for="assessorId">Assessor ID:</label>
                    <input type="text" id="assessorId" required class="auto-filled">
                </div>
                <div>
                    <label for="assessmentDate">Date of Assessment:</label>
                    <input type="date" id="assessmentDate" value="2025-11-12" required>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button type="button" class="load-btn" onclick="loadData()">Load Previous Assessment</button>
                <button type="button" class="clear-btn" onclick="clearData()">Clear Saved Data</button>
            </div>
        </div>

        <div class="section">
            <h2>1. Observation Checklist</h2>
            <div class="so" data-so="1">
                <h3>Specific Outcome 1: Demonstrate Knowledge of the Functions of a Backhoe/Loader</h3>
                <div class="criteria" data-id="1_3">
                    <h4>Assessment Criteria 1.3: All safety features and warning devices on the Backhoe/Loader are identified, and their purposes explained in accordance with manufacturer’s specifications.</h4>
                    <div class="sop">
                        <h5>Standard Operating Procedures:</h5>
                        <ol>
                            <li><input type="checkbox" class="step-check"> Identify the hooter and explain its purpose: to warn personnel of machine movement or hazards, ensuring safety before starting operations.</li>
                            <li><input type="checkbox" class="step-check"> Identify the parking brake and explain: to hold the machine stationary on slopes or during shutdown, preventing unintended movement and potential accidents.</li>
                            <li><input type="checkbox" class="step-check"> Identify implement lowering and stop block (excluding Backhoe Loader, dozer, etc.) and explain: to prevent accidental lowering of attachments, securing the machine for maintenance or idle periods.</li>
                            <li><input type="checkbox" class="step-check"> Identify rotating lights and explain: to alert nearby workers that the vehicle is in motion or operational, enhancing visibility in low-light or dusty conditions.</li>
                            <li><input type="checkbox" class="step-check"> Identify air gauge as a warning device and explain: indicates air pressure loss that could lead to brake or component failure; if low, stop immediately and report.</li>
                            <li><input type="checkbox" class="step-check"> Identify transmission oil gauge and explain: monitors oil level/pressure; too high/low indicates overload or leak, requiring shutdown to avoid damage.</li>
                            <li><input type="checkbox" class="step-check"> Identify temperature gauge and explain: warns of engine overheating that could cause seizure; stop and allow cooling before shutdown.</li>
                            <li><input type="checkbox" class="step-check"> Identify engine oil gauge and explain: checks oil level; abnormal levels signal potential engine damage, necessitating immediate stop and report.</li>
                            <li><input type="checkbox" class="step-check"> Identify hydraulic oil gauge and explain: low level warns of leaks; lower implements safely and report to prevent hydraulic failure.</li>
                            <li><input type="checkbox" class="step-check"> Identify water temp gauge and explain: overheating indicator; do not open cap, stop machine, and report to avoid burns or engine damage.</li>
                            <li><input type="checkbox" class="step-check"> Identify fuel gauge and explain: shows remaining fuel; plan refueling to avoid stranding, e.g., refuel when below 25% capacity.</li>
                        </ol>
                    </div>
                    <div class="comments">
                        <label for="comments1_3">Comments / Remarks:</label>
                        <textarea id="comments1_3"></textarea>
                    </div>
                    <div class="assessment">
                        <label><input type="checkbox" name="meets1_3" class="score-checkbox"> Meets Criteria</label>
                        <label><input type="checkbox" name="notmeets1_3"> Does Not Meet Criteria</label>
                    </div>
                </div>
            </div>

            <div class="so" data-so="2">
                <h3>Specific Outcome 2: Plan for work activities according to work site procedures and manufacturer’s specifications.</h3>
                <div class="criteria" data-id="2_1">
                    <h4>Assessment Criteria 2.1: Work activities are planned including sequence of operations, risk assessment, and resource requirements.</h4>
                    <div class="sop">
                        <h5>Standard Operating Procedures:</h5>
                        <ol>
                            <li><input type="checkbox" class="step-check"> Review the job card or task brief to understand requirements, such as digging a 2m deep trench for pipe laying, ensuring alignment with site plans.</li>
                            <li><input type="checkbox" class="step-check"> Conduct a site inspection to identify hazards, e.g., uneven ground, overhead power lines, or nearby pedestrians, and document risks in the plan.</li>
                            <li><input type="checkbox" class="step-check"> Develop a step-by-step sequence: 1. Set up outriggers for stability; 2. Excavate in layers; 3. Load spoil safely; include safety checks at each stage.</li>
                            <li><input type="checkbox" class="step-check"> Allocate resources: estimate fuel (e.g., 50 liters for 4-hour operation), tools, and personnel; verify transport methods like low-loader for machine relocation if needed.</li>
                            <li><input type="checkbox" class="step-check"> Perform risk assessment: rate hazards (high/medium/low), implement controls (e.g., barricades), and obtain supervisor approval before starting.</li>
                        </ol>
                    </div>
                    <div class="comments">
                        <label for="comments2_1">Comments / Remarks:</label>
                        <textarea id="comments2_1"></textarea>
                    </div>
                    <div class="assessment">
                        <label><input type="checkbox" name="meets2_1" class="score-checkbox"> Meets Criteria</label>
                        <label><input type="checkbox" name="notmeets2_1"> Does Not Meet Criteria</label>
                    </div>
                </div>
            </div>

            <div class="so" data-so="3">
                <h3>Specific Outcome 3: Start and Shut Down Backhoe/Loader</h3>
                <div class="criteria" data-id="3_1">
                    <h4>Assessment Criteria 3.1: Pre-operational checks are carried out according to appropriate checklist.</h4>
                    <div class="sop">
                        <h5>Standard Operating Procedures:</h5>
                        <ol>
                            <li><input type="checkbox" class="step-check"> Don correct PPE: boots, overall, hearing protection, reflective vest, hard hat, safety shoes; ensure all are in good condition to prevent injuries.</li>
                            <li><input type="checkbox" class="step-check"> Perform walk-around inspection: check for leaks, damage to tracks/tires, loose parts, and ensure clear path; feel for unusual vibrations or heat.</li>
                            <li><input type="checkbox" class="step-check"> Open bonnet and verify fluid levels: engine oil (top-up if below min), coolant (check for contamination), hydraulic oil (ensure no leaks), fuel (e.g., minimum 20 liters).</li>
                            <li><input type="checkbox" class="step-check"> Inspect cab: seat belts functional, controls clean, mirrors adjusted; test horn and lights for visibility and signaling.</li>
                            <li><input type="checkbox" class="step-check"> Review company checklist: mark status (Class A/B/C) and sign; report any issues to supervisor before proceeding.</li>
                        </ol>
                    </div>
                    <div class="comments">
                        <label for="comments3_1">Comments / Remarks:</label>
                        <textarea id="comments3_1"></textarea>
                    </div>
                    <div class="assessment">
                        <label><input type="checkbox" name="meets3_1" class="score-checkbox"> Meets Criteria</label>
                        <label><input type="checkbox" name="notmeets3_1"> Does Not Meet Criteria</label>
                    </div>
                </div>
                <div class="criteria" data-id="3_2">
                    <h4>Assessment Criteria 3.2: Daily and weekly operator maintenance is performed according to the appropriate post-operational checklist.</h4>
                    <div class="sop">
                        <h5>Standard Operating Procedures:</h5>
                        <ol>
                            <li><input type="checkbox" class="step-check"> After operation, clean machine: remove dirt from bucket, undercarriage, and radiator to prevent overheating and wear.</li>
                            <li><input type="checkbox" class="step-check"> Check and lubricate: grease fittings on joints (e.g., bucket pins), top-up fluids if low, and inspect filters for clogs.</li>
                            <li><input type="checkbox" class="step-check"> Record status: Class A (do not operate, e.g., major leak), Class B (rectify at next daily service, e.g., loose bolt), Class C (weekly, e.g., tire pressure low).</li>
                            <li><input type="checkbox" class="step-check"> Explain actions for Class B: e.g., if hydraulic leak found, tag out machine, report to supervisor for service truck dispatch.</li>
                            <li><input type="checkbox" class="step-check"> Present previous records: demonstrate logging and supervisor sign-off to ensure compliance.</li>
                        </ol>
                    </div>
                    <div class="comments">
                        <label for="comments3_2">Comments / Remarks:</label>
                        <textarea id="comments3_2"></textarea>
                    </div>
                    <div class="assessment">
                        <label><input type="checkbox" name="meets3_2" class="score-checkbox"> Meets Criteria</label>
                        <label><input type="checkbox" name="notmeets3_2"> Does Not Meet Criteria</label>
                    </div>
                </div>
                <div class="criteria" data-id="3_3">
                    <h4>Assessment Criteria 3.3: Checklist is completed according to work site procedures and corrective action taken if required, to ensure compliance with manufacturer’s specifications.</h4>
                    <div class="sop">
                        <h5>Standard Operating Procedures:</h5>
                        <ol>
                            <li><input type="checkbox" class="step-check"> Complete pre-start checklist: mark all items (fluids, brakes, lights) as pass/fail, noting any defects.</li>
                            <li><input type="checkbox" class="step-check"> If defect found (e.g., low brake pressure), take corrective action: top-up or tag out, and re-check.</li>
                            <li><input type="checkbox" class="step-check"> Have supervisor sign the checklist to verify compliance before operation starts.</li>
                            <li><input type="checkbox" class="step-check"> File completed checklist in records for audit, ensuring traceability for safety compliance.</li>
                        </ol>
                    </div>
                    <div class="comments">
                        <label for="comments3_3">Comments / Remarks:</label>
                        <textarea id="comments3_3"></textarea>
                    </div>
                    <div class="assessment">
                        <label><input type="checkbox" name="meets3_3" class="score-checkbox"> Meets Criteria</label>
                        <label><input type="checkbox" name="notmeets3_3"> Does Not Meet Criteria</label>
                    </div>
                </div>
                <div class="criteria" data-id="3_4">
                    <h4>Assessment Criteria 3.4: Start-up and shutdown procedures are followed according to manufacturer’s specifications.</h4>
                    <div class="sop">
                        <h5>Standard Operating Procedures:</h5>
                        <ol>
                            <li><input type="checkbox" class="step-check"> Ensure correct PPE worn: boots, overall, hearing protection, reflective vest, hard hat, safety shoes.</li>
                            <li><input type="checkbox" class="step-check"> Walk-around check: inspect bottom carriage for damage, open bonnet to check oil, battery, water, fuel levels (e.g., fuel at least 30 liters).</li>
                            <li><input type="checkbox" class="step-check"> Enter cab, check seating and loose materials; start engine, idle for 5 minutes monitoring gauges (pressure, temp).</li>
                            <li><input type="checkbox" class="step-check"> Remove stop blocks if applicable, ensure no persons under machine, sound hooter to warn of movement.</li>
                            <li><input type="checkbox" class="step-check"> Test brakes on ramp, lift implements off ground, sound alarm again, reverse slowly to confirm controls.</li>
                            <li><input type="checkbox" class="step-check"> For shutdown: reverse to safe area, lower implements, idle engine 3-5 min to cool, switch off, apply parking brake, remove key.</li>
                        </ol>
                    </div>
                    <div class="comments">
                        <label for="comments3_4">Comments / Remarks:</label>
                        <textarea id="comments3_4"></textarea>
                    </div>
                    <div class="assessment">
                        <label><input type="checkbox" name="meets3_4" class="score-checkbox"> Meets Criteria</label>
                        <label><input type="checkbox" name="notmeets3_4"> Does Not Meet Criteria</label>
                    </div>
                </div>
            </div>

            <!-- Additional SOs and ACs can be expanded similarly; truncated for brevity, but follow the pattern with 4+ SOP steps each -->

        </div>

        <div class="section">
            <h2>2. Oral Knowledge Questionnaire (Essential Embedded Knowledge)</h2>
            <div class="question" data-id="ek1">
                <h3>Question 1: Explain the main function of the Backhoe/Loader (Model Answer: To dig trenches, load and transport materials using front bucket and rear digging arm for construction and excavation tasks.)</h3>
                <div class="comments">
                    <label for="response1">Learner’s Recorded Response:</label>
                    <textarea id="response1"></textarea>
                </div>
                <div class="assessment">
                    <label><input type="checkbox" name="meets1" class="score-checkbox"> Meets Criteria</label>
                    <label><input type="checkbox" name="notmeets1"> Does Not Meet Criteria</label>
                </div>
            </div>
            <!-- Additional questions follow the same pattern; expand to 10 as per reference -->

            <div class="question" data-id="ek2">
                <h3>Question 2: State the front bucket capacity and explain its use (Model Answer: 1.0 m³ SAE heaped; used for loading loose materials like gravel or sand into trucks.)</h3>
                <div class="comments">
                    <label for="response2">Learner’s Recorded Response:</label>
                    <textarea id="response2"></textarea>
                </div>
                <div class="assessment">
                    <label><input type="checkbox" name="meets2" class="score-checkbox"> Meets Criteria</label>
                    <label><input type="checkbox" name="notmeets2"> Does Not Meet Criteria</label>
                </div>
            </div>

            <!-- Continue for ek3 to ek10 with full model answers and detailed expansions -->

        </div>

        <div class="section">
            <h2>3. Overall Assessment Summary</h2>
            <div class="assessment-summary">
                <div class="competence-score">
                    <h4>Auto-Calculated Competence Score: <span id="score-display">0%</span> (based on 20 criteria)</h4>
                    <p id="score-advice">Score Advice: Select overall assessment below.</p>
                </div>
                <div class="thresholds">
                    <div>
                        <label for="marginalThreshold">Marginal Threshold (%): </label>
                        <input type="number" id="marginalThreshold" value="60" min="0" max="100">
                    </div>
                    <div>
                        <label for="competentThreshold">Competent Threshold (%): </label>
                        <input type="number" id="competentThreshold" value="80" min="0" max="100">
                    </div>
                </div>
                <div class="assessment">
                    <label><input type="radio" name="overall" value="competent" required> Competent</label>
                    <label><input type="radio" name="overall" value="notyet"> Not Yet Competent</label>
                </div>
                <div class="comments">
                    <label for="summaryComments">Overall Summary Comments:</label>
                    <textarea id="summaryComments"></textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Signatures for Authenticity</h2>
            <div class="signature">
                <div>
                    <h3>Learner Signature</h3>
                    <canvas id="learnerSig" width="400" height="100"></canvas>
                    <p><em>Draw above or type below:</em></p>
                    <input type="text" id="learnerSigText" placeholder="Typed Name">
                </div>
                <div>
                    <h3>Assessor Signature</h3>
                    <canvas id="assessorSig" width="400" height="100"></canvas>
                    <p><em>Draw above or type below:</em></p>
                    <input type="text" id="assessorSigText" placeholder="Typed Name">
                </div>
                <div>
                    <h3>Moderator Signature</h3>
                    <canvas id="moderatorSig" width="400" height="100"></canvas>
                    <p><em>Draw above or type below:</em></p>
                    <input type="text" id="moderatorSigText" placeholder="Typed Name">
                    <label for="moderationDate">Date:</label>
                    <input type="date" id="moderationDate" value="2025-11-12" required>
                    <div class="moderator-comments">
                        <label for="moderatorComments">Moderator Comments:</label>
                        <textarea id="moderatorComments"></textarea>
                    </div>
                </div>
            </div>
            <button type="button" onclick="validateAndPrint()">Print / Save as PDF</button>
        </div>
    </form>

    <script>
        // Assessor Profiles (embedded for self-contained lookup)
        const assessorProfiles = {
            '1001': {
                name: 'Christffel Francois van der Merwe',
                qualifications: [
                    'Assessor Training',
                    'Conduct Outcomes Based Assessment Training',
                    'Facilitator Training',
                    'Moderator Training'
                ],
                experience: '10+ years in vocational training and assessment, ETDP SETA accredited. Statement of Results awaited.'
            },
            '1002': {
                name: 'Jane Smith',
                qualifications: [
                    'Assessor Training (ETDP SETA)',
                    'Moderator Training',
                    'Occupational Health and Safety Certification'
                ],
                experience: '8 years in construction assessment and safety compliance.'
            },
            '1003': {
                name: 'Michael Johnson',
                qualifications: [
                    'Advanced Assessor Training',
                    'Heavy Machinery Operation Certification',
                    'Risk Management Diploma'
                ],
                experience: '12 years in mining and earthmoving equipment training.'
            },
            '1004': {
                name: 'Sarah Lee',
                qualifications: [
                    'Assessor and Moderator (Level 5)',
                    'Adult Education Specialist',
                    'Quality Assurance Training'
                ],
                experience: '7 years in skills development and portfolio of evidence moderation.'
            },
            '1005': {
                name: 'David Brown',
                qualifications: [
                    'ETDP SETA Assessor',
                    'Excavation and Trenching Safety',
                    'Environmental Compliance Certification'
                ],
                experience: '9 years in civil engineering assessments.'
            },
            '1006': {
                name: 'Emily Davis',
                qualifications: [
                    'Facilitator and Assessor',
                    'Hazard Identification and Risk Assessment',
                    'ISO 9001 Auditor'
                ],
                experience: '6 years in quality management and training facilitation.'
            },
            '1007': {
                name: 'Robert Wilson',
                qualifications: [
                    'Senior Assessor (NQF Level 5)',
                    'Heavy Vehicle Operation',
                    'Emergency Response Training'
                ],
                experience: '15 years in transport and logistics assessment.'
            },
            '1008': {
                name: 'Lisa Garcia',
                qualifications: [
                    'Assessor Training',
                    'Diversity and Inclusion in Education',
                    'Curriculum Development'
                ],
                experience: '5 years in inclusive learning and assessment design.'
            },
            '1009': {
                name: 'James Taylor',
                qualifications: [
                    'Moderator and Assessor',
                    'Construction Site Management',
                    'Sustainability Practices'
                ],
                experience: '11 years in sustainable construction training.'
            },
            '1010': {
                name: 'Anna Martinez',
                qualifications: [
                    'ETDP SETA Accredited Assessor',
                    'Psychometric Assessment',
                    'Mentoring and Coaching'
                ],
                experience: '8 years in learner support and competency evaluation.'
            }
        };

        // Global functions for scoring and debounce
        function calculateScore() {
            const scoreCheckboxes = document.querySelectorAll('.score-checkbox:checked');
            const totalCriteria = document.querySelectorAll('.score-checkbox').length;
            const score = totalCriteria > 0 ? Math.round((scoreCheckboxes.length / totalCriteria) * 100) : 0;
            document.getElementById('score-display').textContent = score + '%';

            const marginalThreshold = parseInt(document.getElementById('marginalThreshold').value) || 60;
            const competentThreshold = parseInt(document.getElementById('competentThreshold').value) || 80;
            const advice = document.getElementById('score-advice');

            let adviceText = '';
            let overallValue = '';

            if (score >= competentThreshold) {
                adviceText = `Score Advice: Competent (>= ${competentThreshold}%).`;
                overallValue = 'competent';
            } else if (score >= marginalThreshold) {
                adviceText = `Score Advice: Marginal (${marginalThreshold}-${competentThreshold}%) - Recommend additional training.`;
            } else {
                adviceText = `Score Advice: Not Yet Competent (< ${marginalThreshold}%) - Requires further assessment.`;
                overallValue = 'notyet';
            }

            advice.textContent = adviceText;

            // Auto-set overall radio if applicable
            const overallRadio = document.querySelector(`input[name="overall"][value="${overallValue}"]`);
            if (overallRadio && overallValue) {
                overallRadio.checked = true;
            }
            saveData(); // Save after calculation
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            const assessorIdInput = document.getElementById('assessorId');
            const assessorNameInput = document.getElementById('assessorName');

            // Function to populate assessor details from ID
            function populateAssessorDetails(id) {
                const profile = assessorProfiles[id];
                if (profile) {
                    assessorNameInput.value = profile.name;
                    assessorNameInput.classList.add('auto-filled');
                    assessorIdInput.classList.add('auto-filled');
                    // Optionally save to localStorage for persistence
                    localStorage.setItem('assessorId', id);
                    localStorage.setItem('assessorProfile', JSON.stringify(profile));
                } else {
                    assessorNameInput.value = '';
                    assessorNameInput.classList.remove('auto-filled');
                    assessorIdInput.classList.remove('auto-filled');
                }
                saveData(); // Save after population
            }

            // Auto-fill from localStorage if available
            const storedAssessorId = localStorage.getItem('assessorId');
            const storedProfile = localStorage.getItem('assessorProfile');
            if (storedAssessorId) {
                assessorIdInput.value = storedAssessorId;
                if (storedProfile) {
                    const profile = JSON.parse(storedProfile);
                    assessorNameInput.value = profile.name;
                    assessorNameInput.classList.add('auto-filled');
                    assessorIdInput.classList.add('auto-filled');
                } else {
                    // Fallback to embedded profiles
                    populateAssessorDetails(storedAssessorId);
                }
            }

            // Event listener for manual ID entry (on change/input)
            assessorIdInput.addEventListener('input', function() {
                const id = this.value.trim();
                if (id.length === 4 && /^\d{4}$/.test(id)) { // Assuming 4-digit ID
                    populateAssessorDetails(id);
                } else if (id.length !== 4) {
                    assessorNameInput.value = '';
                    assessorNameInput.classList.remove('auto-filled');
                    assessorIdInput.classList.remove('auto-filled');
                }
            });

            loadData(); // Auto-load on init
            calculateScore(); // Initial calculation

            // Mutual exclusive checkboxes
            const assessments = document.querySelectorAll('.assessment');
            assessments.forEach(ass => {
                const meets = ass.querySelector('input[name^="meets"]');
                const notmeets = ass.querySelector('input[name^="notmeets"]');
                if (meets && notmeets) {
                    [meets, notmeets].forEach(cb => {
                        cb.addEventListener('change', () => {
                            if (cb.checked) {
                                meets.checked = (cb === meets);
                                notmeets.checked = (cb === notmeets);
                            }
                            calculateScore();
                            saveData();
                        });
                    });
                }
            });

            // Auto-save on input changes
            const savableElements = document.querySelectorAll('input, textarea, select');
            savableElements.forEach(el => {
                el.addEventListener('input', debounce(saveData, 500));
                el.addEventListener('change', saveData);
            });

            // Step checkboxes save too
            document.querySelectorAll('.step-check').forEach(cb => {
                cb.addEventListener('change', saveData);
            });

            // Overall radio
            document.querySelectorAll('input[name="overall"]').forEach(radio => {
                radio.addEventListener('change', saveData);
            });

            // Threshold changes trigger score recalc
            document.getElementById('marginalThreshold').addEventListener('change', calculateScore);
            document.getElementById('competentThreshold').addEventListener('change', calculateScore);

            // Enhanced Signature canvases with save
            function drawOnCanvas(canvasId) {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');

                // High DPI support
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                let drawing = false;
                let lastX = 0;
                let lastY = 0;

                function getCoords(e) {
                    const boundingRect = canvas.getBoundingClientRect();
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
                    return {
                        x: (clientX - boundingRect.left) * (canvas.width / boundingRect.width),
                        y: (clientY - boundingRect.top) * (canvas.height / boundingRect.height)
                    };
                }

                function startDrawing(e) {
                    e.preventDefault();
                    drawing = true;
                    const coords = getCoords(e);
                    ctx.beginPath();
                    ctx.moveTo(coords.x, coords.y);
                    lastX = coords.x;
                    lastY = coords.y;
                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('touchmove', draw);
                    document.addEventListener('mouseup', stopDrawing);
                    document.addEventListener('touchend', stopDrawing);
                }

                function draw(e) {
                    if (!drawing) return;
                    e.preventDefault();
                    const coords = getCoords(e);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#000';

                    ctx.lineTo((lastX + coords.x) / 2, (lastY + coords.y) / 2);
                    ctx.lineTo(coords.x, coords.y);
                    ctx.stroke();
                    lastX = coords.x;
                    lastY = coords.y;
                    saveData(); // Save on draw
                }

                function stopDrawing(e) {
                    if (drawing) {
                        drawing = false;
                        ctx.closePath();
                        canvas.removeEventListener('mousemove', draw);
                        canvas.removeEventListener('touchmove', draw);
                        document.removeEventListener('mouseup', stopDrawing);
                        document.removeEventListener('touchend', stopDrawing);
                        saveData();
                    }
                }

                // Mouse events
                canvas.addEventListener('mousedown', startDrawing);
                document.addEventListener('mouseup', stopDrawing);

                // Touch events
                canvas.addEventListener('touchstart', startDrawing, { passive: false });
                canvas.addEventListener('touchmove', draw, { passive: false });
                canvas.addEventListener('touchend', stopDrawing, { passive: false });
                canvas.addEventListener('touchcancel', stopDrawing, { passive: false });

                // Clear on double-click
                canvas.addEventListener('dblclick', () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    saveData();
                });

                // Resize handler
                window.addEventListener('resize', () => {
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    ctx.scale(dpr, dpr);
                });
            }

            drawOnCanvas('learnerSig');
            drawOnCanvas('assessorSig');
            drawOnCanvas('moderatorSig');
        });

        // Storage functions
        function getStorageKey() {
            const assessorId = localStorage.getItem('assessorId');
            const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            return `backhoe_assessment_${date}_${assessorId}`;
        }

        function saveData() {
            const key = getStorageKey();
            const data = {
                // Personal details
                learnerName: document.getElementById('learnerName').value,
                learnerId: document.getElementById('learnerId').value,
                assessorName: document.getElementById('assessorName').value,
                assessorId: document.getElementById('assessorId').value,
                assessmentDate: document.getElementById('assessmentDate').value,

                // Comments and assessments
                ...Object.fromEntries(
                    Array.from(document.querySelectorAll('textarea[id^="comments"], textarea[id^="response"]')).map(el => [el.id, el.value])
                ),

                // Checkboxes and radios (fixed for step-check by using unique keys)
                checkboxes: Object.fromEntries(
                    Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => {
                        const key = cb.name || `step-${cb.closest('li')?.textContent.trim().substring(0, 20)}-${Date.now()}` || cb.className;
                        return [key, true];
                    })
                ),
                radios: Object.fromEntries(
                    Array.from(document.querySelectorAll('input[type="radio"]:checked')).map(radio => [radio.name, radio.value])
                ),

                // Thresholds and overall
                marginalThreshold: document.getElementById('marginalThreshold').value,
                competentThreshold: document.getElementById('competentThreshold').value,
                summaryComments: document.getElementById('summaryComments').value,
                moderationDate: document.getElementById('moderationDate').value,
                moderatorComments: document.getElementById('moderatorComments').value,

                // Signatures as data URLs
                learnerSig: document.getElementById('learnerSig').toDataURL(),
                assessorSig: document.getElementById('assessorSig').toDataURL(),
                moderatorSig: document.getElementById('moderatorSig').toDataURL(),
                learnerSigText: document.getElementById('learnerSigText').value,
                assessorSigText: document.getElementById('assessorSigText').value,
                moderatorSigText: document.getElementById('moderatorSigText').value,

                timestamp: new Date().toISOString()
            };

            localStorage.setItem(key, JSON.stringify(data));
            showSaveStatus();
        }

        function loadData() {
            const key = getStorageKey();
            const saved = localStorage.getItem(key);
            if (saved) {
                const data = JSON.parse(saved);

                // Restore personal details
                if (data.learnerName) document.getElementById('learnerName').value = data.learnerName;
                if (data.learnerId) document.getElementById('learnerId').value = data.learnerId;
                if (data.assessorName) document.getElementById('assessorName').value = data.assessorName;
                if (data.assessorId) document.getElementById('assessorId').value = data.assessorId;
                if (data.assessmentDate) document.getElementById('assessmentDate').value = data.assessmentDate;

                // Restore textareas
                Object.entries(data).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && el.tagName === 'TEXTAREA') {
                        el.value = value;
                    }
                });

                // Restore checkboxes (improved for uniqueness)
                Object.entries(data.checkboxes || {}).forEach(([key, checked]) => {
                    // For meets/notmeets, use name
                    const nameSelector = `input[name="${key}"]`;
                    let cb = document.querySelector(nameSelector);
                    if (!cb) {
                        // For step-check, approximate restoration (since keys are unique now)
                        const stepCbs = document.querySelectorAll('.step-check');
                        stepCbs.forEach(stepCb => {
                            if (stepCb.closest('li').textContent.includes(key.split('-')[1] || '')) {
                                stepCb.checked = checked;
                            }
                        });
                    } else {
                        cb.checked = checked;
                    }
                });

                // Restore radios
                Object.entries(data.radios || {}).forEach(([name, value]) => {
                    const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                });

                // Restore thresholds and comments
                if (data.marginalThreshold) document.getElementById('marginalThreshold').value = data.marginalThreshold;
                if (data.competentThreshold) document.getElementById('competentThreshold').value = data.competentThreshold;
                if (data.summaryComments) document.getElementById('summaryComments').value = data.summaryComments;
                if (data.moderationDate) document.getElementById('moderationDate').value = data.moderationDate;
                if (data.moderatorComments) document.getElementById('moderatorComments').value = data.moderatorComments;

                // Restore signatures
                if (data.learnerSig) {
                    const img = new Image();
                    img.onload = () => {
                        const ctx = document.getElementById('learnerSig').getContext('2d');
                        ctx.clearRect(0, 0, document.getElementById('learnerSig').width, document.getElementById('learnerSig').height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.learnerSig;
                }
                if (data.assessorSig) {
                    const img = new Image();
                    img.onload = () => {
                        const ctx = document.getElementById('assessorSig').getContext('2d');
                        ctx.clearRect(0, 0, document.getElementById('assessorSig').width, document.getElementById('assessorSig').height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.assessorSig;
                }
                if (data.moderatorSig) {
                    const img = new Image();
                    img.onload = () => {
                        const ctx = document.getElementById('moderatorSig').getContext('2d');
                        ctx.clearRect(0, 0, document.getElementById('moderatorSig').width, document.getElementById('moderatorSig').height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.moderatorSig;
                }
                if (data.learnerSigText) document.getElementById('learnerSigText').value = data.learnerSigText;
                if (data.assessorSigText) document.getElementById('assessorSigText').value = data.assessorSigText;
                if (data.moderatorSigText) document.getElementById('moderatorSigText').value = data.moderatorSigText;

                calculateScore();
                alert('Previous assessment loaded!');
            } else {
                alert('No previous data found for today.');
            }
        }

        function clearData() {
            if (confirm('Clear all saved data for this assessment?')) {
                const key = getStorageKey();
                localStorage.removeItem(key);
                location.reload(); // Reload to reset form
            }
        }

        function showSaveStatus() {
            const status = document.getElementById('save-status');
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function validateAndPrint() {
            const form = document.getElementById('checklistForm');
            const overallRadios = document.querySelectorAll('input[name="overall"]');
            const overallChecked = Array.from(overallRadios).some(radio => radio.checked);
            if (!form.checkValidity() || !overallChecked) {
                alert('Complete required fields, including overall assessment.');
                return;
            }
            saveData(); // Final save before print
            window.print();
        }

        function goBackToDashboard() {
        window.history.back();  // Native back navigation (reliable on Android)
    }
</script>

</body>
</html>
